name: Build and Deploy DataGateVPNBot

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Setup .NET 8
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 8.0.x

    - name: Restore dependencies
      run: dotnet restore ./DataGateVPNBotV1.csproj

    - name: Build application
      run: dotnet publish ./DataGateVPNBotV1.csproj -c Release -r linux-arm64 --self-contained false -o ./publish

    - name: Set up SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.RPI_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy application to Raspberry Pi
      run: |
        rsync -av --exclude 'appsettings.json' --exclude 'appsettings.Development.json' ./publish/ ${{ secrets.RPI_USER }}@${{ secrets.RPI_HOST }}:/home/${{ secrets.RPI_USER }}/DataGateVPNBot/
        ssh ${{ secrets.RPI_USER }}@${{ secrets.RPI_HOST }} << 'EOF'
          export DOTNET_ROOT=/home/${{ secrets.RPI_USER }}/.dotnet
          export PATH=$PATH:/home/${{ secrets.RPI_USER }}/.dotnet
          cd /home/${{ secrets.RPI_USER }}/DataGateVPNBot/
          chmod +x DataGateVPNBotV1
          pkill -f DataGateVPNBotV1 || true
          rm -f bot.log
          nohup ./DataGateVPNBotV1 >> bot.log 2>&1 &
          sleep 10
          echo "=== Application Status ==="
          ps aux | grep DataGateVPNBotV1 | grep -v grep || echo "Application is not running"
          echo "=== Application Logs ==="
          cat bot.log || echo "No logs available"
        EOF
